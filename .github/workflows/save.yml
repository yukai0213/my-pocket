name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'è«‹è¼¸å…¥è¦æŠ“å–çš„ç¶²å€ (URL)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v10
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- æ­¥é©Ÿ 1: å»ºç«‹ã€ŒID ç¨ä½”å»é‡ç‰ˆã€YouTube å½è£è…³æœ¬ ---
      - name: Create Dedupe YouTube Faker Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("ğŸ¦„ V8 ID ç¨ä½”å»é‡è…³æœ¬å•Ÿå‹•...");

            function fixYoutube() {
                // 1. æŠ“å‡ºæ‰€æœ‰ iframe
                const iframes = document.querySelectorAll('iframe');
                
                iframes.forEach(iframe => {
                    const src = iframe.src || iframe.dataset.src || "";
                    const isYoutube = src.includes('youtube.com') || src.includes('youtu.be') || src.includes('youtube-nocookie.com');
                    
                    if (isYoutube) {
                        // å˜—è©¦æå–å½±ç‰‡ ID
                        let videoId = "unknown";
                        const match = src.match(/([a-zA-Z0-9_-]{11})/);
                        if (match) videoId = match[1];

                        // --- V8 é—œéµé‚è¼¯ï¼šæª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨è©² ID çš„å½è£å™¨ ---
                        const uniqueId = 'fake-player-' + videoId;
                        const existingPlayer = document.getElementById(uniqueId);

                        if (existingPlayer) {
                            // æƒ…æ³ A: å·²ç¶“åšå¥½äº†ï¼Œé€™å€‹ iframe æ˜¯å¤šé¤˜çš„é‡ç”Ÿæ€ª
                            console.log("ğŸ—‘ï¸ ç™¼ç¾é‡è¤‡çš„ iframe (" + videoId + ")ï¼Œç›´æ¥åˆªé™¤ï¼");
                            iframe.remove(); // æ®ºæ‰å®ƒï¼
                            return; 
                        }

                        // æƒ…æ³ B: æ²’åšéï¼Œé–‹å§‹è£½ä½œ
                        console.log("âœ¨ è£½ä½œæ–°çš„å½è£å™¨: " + videoId);
                        
                        const bgImage = (videoId !== "unknown") ? 
                            'url(https://img.youtube.com/vi/' + videoId + '/hqdefault.jpg)' : 
                            'linear-gradient(45deg, #cc0000, #000)';

                        const rect = iframe.getBoundingClientRect();
                        // å¦‚æœ iframe é‚„æ²’è¼‰å…¥å¯¬é«˜ï¼Œçµ¦å€‹é è¨­å€¼
                        const width = rect.width > 10 ? rect.width + "px" : "100%";
                        const height = rect.height > 10 ? rect.height + "px" : "315px";
                        
                        const targetUrl = (videoId !== "unknown") ? 'https://www.youtube.com/watch?v=' + videoId : src;

                        // å»ºç«‹è¶…é€£çµå¯¦é«”æŒ‰éˆ•
                        const fakePlayer = document.createElement('a');
                        fakePlayer.id = uniqueId; // è³¦äºˆèº«åˆ†è­‰ï¼Œé˜²æ­¢é‡è¤‡
                        fakePlayer.href = targetUrl;
                        fakePlayer.target = "_blank";
                        fakePlayer.rel = "noopener noreferrer";
                        
                        fakePlayer.style.cssText = \`
                            width: \${width};
                            height: \${height};
                            min-height: 315px; /* å¼·åˆ¶æœ€å°é«˜åº¦ */
                            background: #000 \${bgImage} center/cover no-repeat;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            text-decoration: none;
                            border-radius: 8px;
                            position: relative;
                            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                            margin: 10px auto;
                            z-index: 999;
                        \`;

                        fakePlayer.innerHTML = \`
                            <div style="background:rgba(0,0,0,0.6);width:100%;height:100%;display:flex;align-items:center;justify-content:center;border-radius:8px;">
                                <div style="background:red;width:60px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);">
                                    <div style="width:0;height:0;border-top:8px solid transparent;border-bottom:8px solid transparent;border-left:12px solid white;margin-left:4px;"></div>
                                </div>
                                <div style="position:absolute;bottom:10px;color:white;font-size:12px;background:rgba(0,0,0,0.5);padding:2px 6px;border-radius:4px;font-family:sans-serif;">
                                    é»æ“Šé–‹å•Ÿå½±ç‰‡
                                </div>
                            </div>
                        \`;
                        
                        // æ›¿æ›ï¼
                        if(iframe.parentNode) {
                            iframe.replaceWith(fakePlayer);
                        }
                    }
                });
            }

            // æš´åŠ›æƒæï¼šæ¯ 200ms æƒä¸€æ¬¡ï¼Œæƒ 100 æ¬¡ (å…± 20 ç§’)
            // å› ç‚ºæœ‰å»é‡æ©Ÿåˆ¶ï¼Œæ‰€ä»¥æƒå¿«ä¸€é»ä¹Ÿæ²’é—œä¿‚
            let attempts = 0;
            const interval = setInterval(() => {
                fixYoutube();
                attempts++;
                if (attempts > 100) clearInterval(interval);
            }, 200);
            
            // å¼·åˆ¶è§¸ç™¼ä¸€æ¬¡
            fixYoutube();
          })();
          EOF

      # --- æ­¥é©Ÿ 2: åŸ·è¡ŒæŠ“å– ---
      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "æ­£åœ¨æŠ“å–: ${{ inputs.url }}"
          
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=3000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          git push
