name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'è«‹è¼¸å…¥è¦æŠ“å–çš„ç¶²å€ (URL)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

# ç§»é™¤ concurrency è¨­å®šï¼Œæ”¹ç”¨ä½‡åˆ—æ¨¡å¼ï¼Œé¿å…å–æ¶ˆèˆŠä»»å‹™
# é€™æ¨£ä½ é€£çºŒæŒ‰å¹¾æ¬¡ï¼Œå®ƒå°±æœƒæ’éšŠè·‘å¹¾æ¬¡

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # æŠ“å–å®Œæ•´æ­·å²ï¼Œç‚ºäº†å¾Œé¢çš„åŒæ­¥åˆä½µ

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v43
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- æ­¥é©Ÿ 1: å»ºç«‹ã€ŒV43 åŸç”Ÿå¾©åŸç‰ˆã€è…³æœ¬ ---
      # é€™å€‹è…³æœ¬ä¸åšä»»ä½•å¤–è§€æ›¿æ›ï¼Œåªè² è²¬æŠŠ "ç›¸å°è·¯å¾‘" ä¿®å¾©æˆ "çµ•å°è·¯å¾‘"
      - name: Create Native Restore Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("â™»ï¸ V43 åŸç”Ÿå¾©åŸç‰ˆï¼šå•Ÿå‹• (åªä¿®é€£çµï¼Œä¸å‹•çµæ§‹)");

            // 1. ä¸»å‹•æ²å‹•é é¢ï¼Œè§¸ç™¼æ‡¶åŠ è¼‰å…ƒç´ å‡ºç¾
            window.scrollBy(0, 100);
            setTimeout(() => window.scrollBy(0, -100), 500);

            // è¼”åŠ©å‡½å¼ï¼šæŠŠç›¸å°è·¯å¾‘ (e.g. /video.mp4) è½‰æˆ çµ•å°è·¯å¾‘ (e.g. https://site.com/video.mp4)
            function toAbsolute(url) {
                if (!url) return "";
                if (url.startsWith('http')) return url; // å·²ç¶“æ˜¯çµ•å°è·¯å¾‘
                if (url.startsWith('//')) return 'https:' + url; // ä¿®æ­£ // é–‹é ­
                
                try {
                    // ä½¿ç”¨ç€è¦½å™¨å…§å»º URL ç‰©ä»¶è¨ˆç®—å®Œæ•´è·¯å¾‘
                    return new URL(url, document.baseURI).href;
                } catch (e) {
                    return url;
                }
            }

            function restoreAll() {
                // --- A. è™•ç† HTML5 <video> (Wondershare é¦–é ä¸»è¦æ˜¯é€™å€‹) ---
                const videos = document.querySelectorAll('video');
                videos.forEach(video => {
                    // å¦‚æœå·²ç¶“è™•ç†éï¼Œè·³é
                    if (video.dataset.fixed === "true") return;

                    // æŠ“å–å½±ç‰‡ä¾†æº (å„ªå…ˆæŠ“ currentSrcï¼Œæ²’æœ‰å‰‡æŠ“ src æˆ– source æ¨™ç±¤)
                    let src = video.currentSrc || video.src || "";
                    if (!src) {
                        const source = video.querySelector('source');
                        if (source) src = source.src;
                    }

                    if (src) {
                        // 1. è¨ˆç®—çµ•å°è·¯å¾‘ (é€™æ˜¯æœ€é—œéµçš„ä¸€æ­¥)
                        // é€™æ¨£å­˜æª”å¾Œï¼Œæœ¬æ©Ÿ HTML æ‰çŸ¥é“å»å“ªè£¡æŠ“å½±ç‰‡
                        const absoluteSrc = toAbsolute(src);
                        
                        if (absoluteSrc !== src) {
                            console.log("ğŸ”§ ä¿®å¾© Video é€£çµ: " + absoluteSrc);
                            video.src = absoluteSrc;
                        }

                        // 2. å¼·åˆ¶è¨­å®šè‡ªå‹•æ’­æ”¾å±¬æ€§
                        // ç€è¦½å™¨è¦å®šï¼šè¦è‡ªå‹•æ’­æ”¾(autoplay)å¿…é ˆåŒæ™‚éœéŸ³(muted)
                        video.muted = true;
                        video.autoplay = true;
                        video.loop = true;     // è®“å®ƒå¾ªç’°æ’­æ”¾ï¼ŒåƒèƒŒæ™¯ä¸€æ¨£
                        video.playsInline = true; // æ‰‹æ©Ÿç‰ˆä¸è¦å…¨è¢å¹•
                        video.controls = true; // åŠ ä¸Šæ§åˆ¶æ¢ (ä¿éšªèµ·è¦‹ï¼Œè®“ä½ ä¸‹è¼‰å¾Œèƒ½æ‰‹å‹•é»)

                        video.dataset.fixed = "true";
                    }
                });

                // --- B. è™•ç† iframe (YouTube/Vimeo) ---
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    if (iframe.dataset.fixed === "true") return;

                    let src = iframe.src || iframe.dataset.src || "";
                    
                    // å¦‚æœ iframe æ˜¯ç›¸å°è·¯å¾‘ï¼Œä¹Ÿå¹«å®ƒä¿®å¥½
                    if (src && !src.startsWith('http') && !src.startsWith('data:')) {
                        const absoluteSrc = toAbsolute(src);
                        console.log("ğŸ”§ ä¿®å¾© Iframe é€£çµ: " + absoluteSrc);
                        iframe.src = absoluteSrc;
                    }
                    
                    // é€™è£¡æˆ‘å€‘å®Œå…¨ä¸å‹• iframe çš„æ¨£å¼å’Œä½ç½®
                    // è®“å®ƒä¿æŒåŸæ¨£ï¼ŒSingleFile æœƒç›¡åŠ›å»å­˜
                    iframe.dataset.fixed = "true";
                });
            }

            // æŒçºŒæƒæ 10 ç§’ (æ‡‰å°æ‡¶åŠ è¼‰)
            let attempts = 0;
            const interval = setInterval(() => {
                restoreAll();
                attempts++;
                if (attempts > 20) clearInterval(interval);
            }, 500);
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            restoreAll();
          })();
          EOF

      # --- æ­¥é©Ÿ 2: åŸ·è¡ŒæŠ“å– ---
      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "æ­£åœ¨æŠ“å–: ${{ inputs.url }}"
          
          # åŸ·è¡Œ SingleFileï¼Œæ›è¼‰æˆ‘å€‘çš„ V43 è…³æœ¬
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=3000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          # è¨­å®š Git èº«ä»½
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          
          # åŠ å…¥æª”æ¡ˆ
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          
          # --- è‡ªå‹•æ’éšŠåŒæ­¥æ©Ÿåˆ¶ ---
          # å¦‚æœå› ç‚ºå¤šäººåŒæ™‚å­˜æª”å°è‡´ push å¤±æ•—ï¼Œé€™è£¡æœƒè‡ªå‹•æ‹‰å–æœ€æ–°é€²åº¦ä¸¦é‡è©¦
          # é€™æ¨£ä½ å°±å¯ä»¥é€£çºŒæŒ‰ä¿å­˜ï¼Œä¸ç”¨ç­‰äº†
          n=0
          until [ "$n" -ge 10 ]
          do
             git pull --rebase && git push && break
             n=$((n+1))
             echo "ä¸Šå‚³è¡çªï¼Œæ­£åœ¨è‡ªå‹•åŒæ­¥é‡è©¦ (ç¬¬ $n æ¬¡)..."
             sleep 5
          done
