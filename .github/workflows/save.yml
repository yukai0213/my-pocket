name: Save Webpage
# 設定手動觸發，並要求輸入網址
on:
  workflow_dispatch:
    inputs:
      url:
        description: '請輸入要抓取的網址 (URL)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 優化：快取 npm 套件，讓第二次之後執行變快
      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      - name: Save Page
        run: |
          # 設定檔名為：saved-年月日-時分秒.html
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "正在抓取: ${{ inputs.url }}"
          echo "存檔名稱: $FILENAME"
          
          # --- 關鍵修改 ---
          # 1. --block-scripts=false : 允許執行 JS (讓 YT 播放器跑出來)
          # 2. --block-frames=false  : 允許鑲嵌視窗 (保留 YT 的 iframe)
          # 3. --load-deferred-images-max-idle-time=2000 : 等待懶加載圖片
          
          timeout 3m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --block-scripts=false \
            --block-frames=false \
            --load-deferred-images-max-idle-time=2000
          
          # 設定 Git 身分並上傳
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          git push
