name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL'
        required: true

permissions:
  contents: write
  pages: write
  id-token: write

# --- é—œéµä¿®æ­£ï¼šå®Œå…¨ç§»é™¤ concurrency è¨­å®š ---
# é€™æ¨£ GitHub å°±ä¸æœƒå› ç‚ºã€ŒåŒçµ„ã€è€Œå–æ¶ˆèˆŠä»»å‹™
# å®ƒæœƒè®Šæˆ First-In-First-Out çš„ä½‡åˆ—æ¨¡å¼

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v31
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- è…³æœ¬é‚è¼¯ (ç¶­æŒ V29/V30 çš„ç©©å®šç‰ˆ) ---
      - name: Create Faker Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("ğŸš€ V31 æ’éšŠç©©å®šç‰ˆ");

            function fixAllIframes() {
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    const src = iframe.src || iframe.dataset.src || "";
                    if (!src || src === "about:blank") return;
                    if (iframe.offsetWidth < 50 || iframe.offsetHeight < 50) return;
                    if (iframe.dataset.patched === "true") return;

                    const parent = iframe.parentElement;
                    if (!parent) return;

                    const parentStyle = window.getComputedStyle(parent);
                    if (parentStyle.position === 'static') parent.style.position = 'relative';

                    let bgImage = '';
                    let bgColor = '#222';
                    let btnText = "é»æ“Šé–‹å•Ÿ å¤–éƒ¨åµŒå…¥å…§å®¹";
                    let btnIcon = "ğŸ”—";
                    let btnColor = "#007bff";
                    let linkUrl = src;

                    // YouTube
                    if (src.includes('youtube') || src.includes('youtu.be')) {
                        const match = src.match(/([a-zA-Z0-9_-]{11})/);
                        if (match) {
                            bgImage = 'url(https://img.youtube.com/vi/' + match[1] + '/hqdefault.jpg)';
                            bgColor = '#000';
                            btnText = "é»æ“Šé–‹å•Ÿ YouTube å½±ç‰‡";
                            btnIcon = "â–¶";
                            btnColor = "#cc0000";
                            linkUrl = 'https://www.youtube.com/watch?v=' + match[1];
                        }
                    }

                    // Vimeo
                    if (src.includes('vimeo.com')) {
                        const match = src.match(/video\/(\d+)/);
                        if (match) {
                            bgImage = 'url(https://vumbnail.com/' + match[1] + '.jpg)';
                            bgColor = '#000';
                            btnText = "é»æ“Šé–‹å•Ÿ Vimeo å½±ç‰‡";
                            btnIcon = "â–¶";
                            btnColor = "#1ab7ea";
                            linkUrl = 'https://vimeo.com/' + match[1];
                        }
                    }

                    const card = document.createElement('a');
                    card.href = linkUrl;
                    card.target = "_blank";
                    card.rel = "noopener noreferrer";
                    card.style.cssText = \`
                        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                        background-color: \${bgColor}; background-image: \${bgImage};
                        background-position: center; background-size: cover; background-repeat: no-repeat;
                        display: flex; flex-direction: column; align-items: center; justify-content: center;
                        text-decoration: none; z-index: 10; box-sizing: border-box; border: 2px solid \${btnColor};
                    \`;
                    
                    card.innerHTML = \`
                        <div style="background:rgba(0,0,0,0.6);width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                            <div style="font-size:40px;margin-bottom:10px;">\${btnIcon}</div>
                            <div style="background-color:\${btnColor};color:white;padding:8px 16px;border-radius:4px;font-weight:bold;">\${btnText}</div>
                        </div>
                    \`;

                    parent.appendChild(card);
                    iframe.style.opacity = '0';
                    iframe.style.pointerEvents = 'none';
                    iframe.dataset.patched = "true";
                });
            }
            setInterval(fixAllIframes, 500);
          })();
          EOF

      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=3000 \
            --browser-width=1920 --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          
          # ä¾ç„¶ä¿ç•™è‡ªå‹•åŒæ­¥ï¼Œä»¥é˜²è¬ä¸€
          n=0
          until [ "$n" -ge 10 ]
          do
             git pull --rebase && git push && break
             n=$((n+1))
             sleep 5
          done
