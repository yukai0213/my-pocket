name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: '請輸入要抓取的網址 (URL)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v2
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "正在抓取: ${{ inputs.url }}"
          
          # --- V2 修復版：核彈級參數 ---
          # 1. --disable-web-security : 允許跨域讀取 (CORS)
          # 2. --disable-features=IsolateOrigins,site-per-process : 關閉網站隔離 (解決 iframe 空白的主因)
          # 3. --window-size=1920,1080 : 確保視窗夠大，觸發 YouTube 渲染
          # 4. --remove-hidden-elements=false : 防止 SingleFile 誤刪它以為看不到的內容
          
          timeout 3m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --block-scripts=false \
            --block-frames=false \
            --remove-hidden-elements=false \
            --load-deferred-images-max-idle-time=2000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox", "--disable-web-security", "--disable-features=IsolateOrigins,site-per-process", "--window-size=1920,1080"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          git push
