name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'è«‹è¼¸å…¥è¦æŠ“å–çš„ç¶²å€ (URL)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v5
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- æ­¥é©Ÿ 1: å»ºç«‹ã€Œé€£çµé¡¯å½¢ã€è…³æœ¬ ---
      - name: Create Link Extractor Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("ğŸ”— é€£çµé¡¯å½¢è…³æœ¬å•Ÿå‹•...");

            function extractLinks() {
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    // 1. å–å¾—ç¶²å€
                    const src = iframe.src || iframe.dataset.src || "";
                    
                    // 2. å¦‚æœå·²ç¶“è™•ç†éï¼Œæˆ–ç¶²å€æ˜¯ç©ºçš„ï¼Œå°±è·³é
                    if (iframe.dataset.extracted === "true" || !src) return;

                    console.log("ç™¼ç¾ iframe: " + src);

                    // 3. åˆ¤æ–·æ˜¯å¦ç‚ºå½±ç‰‡ (YouTube)
                    // (å³ä½¿ä¸æ˜¯ YTï¼Œæˆ‘å€‘ä¹ŸæŠŠé€£çµé¡¯ç¤ºå‡ºä¾†ï¼Œå¯§æ®ºéŒ¯ä¸æ”¾é)
                    let isVideo = src.includes("youtube") || src.includes("youtu.be") || src.includes("vimeo");
                    
                    // 4. è£½ä½œä¸€å€‹è¶…æ˜é¡¯çš„æŒ‰éˆ•
                    const linkBtn = document.createElement('a');
                    linkBtn.href = src;
                    linkBtn.target = "_blank";
                    linkBtn.style.display = "block";
                    linkBtn.style.padding = "15px";
                    linkBtn.style.margin = "10px 0";
                    linkBtn.style.backgroundColor = isVideo ? "#cc0000" : "#444"; // YTç”¨ç´…è‰²ï¼Œå…¶ä»–ç”¨ç°è‰²
                    linkBtn.style.color = "#fff";
                    linkBtn.style.textDecoration = "none";
                    linkBtn.style.fontWeight = "bold";
                    linkBtn.style.fontSize = "16px";
                    linkBtn.style.textAlign = "center";
                    linkBtn.style.borderRadius = "8px";
                    linkBtn.style.border = "2px solid white";
                    linkBtn.style.boxShadow = "0 2px 5px rgba(0,0,0,0.3)";
                    linkBtn.style.zIndex = "99999"; // ç¢ºä¿åœ¨æœ€ä¸Šå±¤
                    
                    // æŒ‰éˆ•æ–‡å­—
                    linkBtn.innerText = isVideo ? "ğŸ¬ åµæ¸¬åˆ°å½±ç‰‡ï¼Œé»æ­¤é–‹å•Ÿé€£çµ (" + src + ")" : "ğŸ”— åµæ¸¬åˆ°å¤–éƒ¨æ¡†æ¶ï¼Œé»æ­¤é–‹å•Ÿé€£çµ";

                    // 5. æ’å…¥åˆ° iframe çš„ã€Œæ­£ä¸Šæ–¹ã€
                    // é€™æ¨£å°±ç®— iframe æ˜¯ç©ºç™½çš„ï¼Œä½ ä¹Ÿèƒ½çœ‹åˆ°é€™å€‹æŒ‰éˆ•
                    if(iframe.parentNode) {
                        iframe.parentNode.insertBefore(linkBtn, iframe);
                        iframe.dataset.extracted = "true"; // æ¨™è¨˜å·²è™•ç†
                    }
                });
            }

            // æ¯ 1 ç§’æƒæä¸€æ¬¡ï¼ŒæŒçºŒ 30 ç§’ (æ‡‰ä»˜æ‡¶åŠ è¼‰)
            // é€™ç¨®ç´” DOM æ“ä½œéå¸¸è¼•é‡ï¼Œä¸æœƒç•¶æ©Ÿ
            let attempts = 0;
            const interval = setInterval(() => {
                extractLinks();
                attempts++;
                if (attempts > 30) clearInterval(interval);
            }, 1000);
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            extractLinks();

          })();
          EOF

      # --- æ­¥é©Ÿ 2: åŸ·è¡ŒæŠ“å– ---
      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "æ­£åœ¨æŠ“å–: ${{ inputs.url }}"
          
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=2000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          git push
