name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'è«‹è¼¸å…¥è¦æŠ“å–çš„ç¶²å€ (URL)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v15
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- æ­¥é©Ÿ 1: å»ºç«‹ã€ŒV15 åœ–æ–‡åˆ†é›¢ã€YouTube ä¿®å¾©è…³æœ¬ ---
      - name: Create Split-Layout Faker Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("ğŸ–¼ï¸ V15 åœ–æ–‡åˆ†é›¢ç‰ˆï¼šå•Ÿå‹•");

            function fixYoutube() {
                const iframes = document.querySelectorAll('iframe');
                
                iframes.forEach(iframe => {
                    const src = iframe.src || iframe.dataset.src || "";
                    
                    // 1. åˆ¤æ–·æ˜¯å¦ç‚º YouTube
                    if (!src.includes('youtube') && !src.includes('youtu.be')) return;
                    
                    // 2. æŠ“å– ID
                    const match = src.match(/([a-zA-Z0-9_-]{11})/);
                    const videoId = match ? match[1] : null;
                    if (!videoId) return;

                    // --- V15 é—œéµé˜²é‡é‚è¼¯ ---
                    // æª¢æŸ¥ï¼šé€™å€‹ iframe çš„ã€Œå‰ä¸€å€‹é„°å±…ã€æ˜¯ä¸æ˜¯å·²ç¶“æ˜¯æˆ‘å€‘åšå¥½çš„å®¹å™¨ï¼Ÿ
                    const prev = iframe.previousElementSibling;
                    if (prev && prev.classList.contains('my-yt-container')) {
                        // å·²ç¶“åšéäº†ï¼
                        // ç¢ºä¿ iframe æ˜¯éš±è—çš„ï¼Œç„¶å¾Œé›¢é–‹
                        iframe.style.display = 'none';
                        return;
                    }

                    console.log("âœ¨ è£½ä½œåœ–æ–‡åˆ†é›¢å€å¡Š: " + videoId);

                    // æº–å‚™ç´ æ
                    const bgImage = 'url(https://img.youtube.com/vi/' + videoId + '/hqdefault.jpg)';
                    const targetUrl = 'https://www.youtube.com/watch?v=' + videoId;
                    
                    // æŠ“å–å¯¬åº¦ (é«˜åº¦ä¸é‡è¦äº†ï¼Œå› ç‚ºæˆ‘å€‘æœƒè‡ªå·±æ’é–‹)
                    let width = iframe.offsetWidth > 10 ? iframe.offsetWidth + "px" : "100%";

                    // --- å»ºç«‹ä¸»å®¹å™¨ ---
                    const container = document.createElement('div');
                    container.className = 'my-yt-container'; // æ¨™è¨˜èº«åˆ†
                    container.style.cssText = \`
                        width: \${width};
                        margin: 20px auto;
                        font-family: sans-serif;
                        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                        border-radius: 8px;
                        overflow: hidden;
                        background: #f0f0f0;
                    \`;

                    // --- A. ä¸Šæ–¹ï¼šç´”åœ–ç‰‡å€ (ä¸å¯é») ---
                    const imgDiv = document.createElement('div');
                    imgDiv.style.cssText = \`
                        width: 100%;
                        height: 315px; /* å›ºå®šé«˜åº¦æ¯”è¼ƒæ•´é½Š */
                        background: #000 \${bgImage} center/cover no-repeat;
                        border-bottom: 1px solid #ddd;
                    \`;

                    // --- B. ä¸‹æ–¹ï¼šæŒ‰éˆ•å€ (é€£çµ) ---
                    const btnArea = document.createElement('div');
                    btnArea.style.cssText = \`
                        padding: 15px;
                        text-align: center;
                        background: #fff;
                    \`;

                    const linkBtn = document.createElement('a');
                    linkBtn.href = targetUrl;
                    linkBtn.target = "_blank";
                    linkBtn.rel = "noopener noreferrer";
                    linkBtn.innerText = "ğŸ“º é»æ“Šå‰å¾€ YouTube è§€çœ‹å½±ç‰‡";
                    linkBtn.style.cssText = \`
                        display: inline-block;
                        background-color: #cc0000;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 5px;
                        text-decoration: none;
                        font-weight: bold;
                        font-size: 16px;
                    \`;

                    // çµ„è£
                    btnArea.appendChild(linkBtn);
                    container.appendChild(imgDiv);
                    container.appendChild(btnArea);

                    // --- æ’å…¥èˆ‡éš±è— ---
                    if(iframe.parentNode) {
                        // æ’åœ¨ iframe å‰é¢
                        iframe.parentNode.insertBefore(container, iframe);
                        // éš±è— iframe
                        iframe.style.display = 'none';
                    }
                });
            }

            // æƒææ©Ÿåˆ¶ï¼šæ¯ 500ms æª¢æŸ¥ä¸€æ¬¡ï¼ŒæŒçºŒ 20 ç§’
            // å› ç‚ºæœ‰ "previousElementSibling" çš„æª¢æŸ¥ï¼Œé‡è¤‡æƒæä¹Ÿä¸æœƒé‡è¤‡ç”Ÿ
            let attempts = 0;
            const interval = setInterval(() => {
                fixYoutube();
                attempts++;
                if (attempts > 40) clearInterval(interval);
            }, 500);
            
            fixYoutube();
          })();
          EOF

      # --- æ­¥é©Ÿ 2: åŸ·è¡ŒæŠ“å– ---
      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "æ­£åœ¨æŠ“å–: ${{ inputs.url }}"
          
          # æ¢å¾©ç‚º 3000ms ç­‰å¾…ï¼Œé€™å°å¤§éƒ¨åˆ†ç¶²é å¤ ç”¨äº†
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=3000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          git push
