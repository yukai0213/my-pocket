name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'è«‹è¼¸å…¥è¦æŠ“å–çš„ç¶²å€ (URL)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v17
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- æ­¥é©Ÿ 1: å»ºç«‹ã€ŒV17 éç ´å£æ€§æ¨™è¨»ã€ä¿®å¾©è…³æœ¬ ---
      - name: Create Non-Destructive Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("ğŸ·ï¸ V17 éç ´å£æ€§æ¨™è¨»ç‰ˆï¼šå•Ÿå‹•");

            function patchIframes() {
                const iframes = document.querySelectorAll('iframe');
                
                iframes.forEach(iframe => {
                    // --- æ ¸å¿ƒé˜²é‡æ©Ÿåˆ¶ï¼šç›´æ¥æª¢æŸ¥ iframe èº«ä¸Šæœ‰æ²’æœ‰æ¨™ç±¤ ---
                    if (iframe.dataset.patched === "true") return;

                    const src = iframe.src || iframe.dataset.src || "";
                    if (!src) return;

                    // é€™è£¡æˆ‘å€‘åšå¯¬é¬†åˆ¤å®šï¼Œåªè¦æ˜¯ iframe éƒ½çµ¦å®ƒä¸€å€‹é€£çµæŒ‰éˆ•
                    // å› ç‚ºæœ‰äº›å½±ç‰‡ä¸ä¸€å®šæ˜¯ YouTubeï¼Œå¯èƒ½æ˜¯ Vimeo æˆ–å…¶ä»–
                    // æˆ‘å€‘çµ±ä¸€æä¾›ã€ŒåŸå§‹é€£çµã€
                    
                    console.log("ğŸ”§ æ¨™è¨» iframe: " + src);

                    // 1. å»ºç«‹æŒ‰éˆ•
                    const linkBtn = document.createElement('a');
                    linkBtn.href = src;
                    linkBtn.target = "_blank";
                    linkBtn.rel = "noopener noreferrer";
                    
                    // æ ¹æ“šæ˜¯å¦ç‚º YouTube çµ¦äºˆä¸åŒé¡è‰²æç¤º
                    const isYoutube = src.includes('youtube') || src.includes('youtu.be');
                    const btnText = isYoutube ? "ğŸ“º YouTube å½±ç‰‡ (é»æ­¤é–‹å•Ÿ)" : "ğŸ”— å¤–éƒ¨åµŒå…¥å…§å®¹ (é»æ­¤é–‹å•Ÿ)";
                    const btnColor = isYoutube ? "#d32f2f" : "#555";

                    linkBtn.innerText = btnText;
                    
                    // æ¨£å¼ï¼šç°¡å–®ã€ä¹¾æ·¨ã€ä¸å¹²æ“¾æ’ç‰ˆ
                    linkBtn.style.cssText = \`
                        display: block;
                        background-color: \${btnColor};
                        color: white;
                        padding: 12px 20px;
                        margin: 10px 0;
                        text-align: center;
                        text-decoration: none;
                        font-weight: bold;
                        border-radius: 6px;
                        font-family: sans-serif;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    \`;

                    // 2. æ’å…¥æŒ‰éˆ• (åœ¨ iframe å‰é¢)
                    if(iframe.parentNode) {
                        iframe.parentNode.insertBefore(linkBtn, iframe);
                        
                        // 3. éš±è— iframe (ä½†ä¸åˆªé™¤ï¼é˜²æ­¢ç¶²é å†ç”Ÿ)
                        iframe.style.display = 'none';
                        
                        // 4. æ‰“ä¸Šæ¨™è¨˜ (é€™æ˜¯æœ€é‡è¦çš„ï¼)
                        iframe.dataset.patched = "true";
                    }
                });
            }

            // æº«å’Œæƒæï¼šæ¯ 1 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼ŒæŒçºŒ 15 ç§’
            // å› ç‚ºæˆ‘å€‘ä¸åˆªé™¤å…ƒç´ ï¼Œæ‰€ä»¥ç¶²é ä¸æœƒä¸€ç›´ã€ŒåæŠ—ã€ï¼Œæƒæé »ç‡å¯ä»¥é™ä½
            let attempts = 0;
            const interval = setInterval(() => {
                patchIframes();
                attempts++;
                if (attempts > 15) clearInterval(interval);
            }, 1000);
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            patchIframes();
          })();
          EOF

      # --- æ­¥é©Ÿ 2: åŸ·è¡ŒæŠ“å– ---
      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "æ­£åœ¨æŠ“å–: ${{ inputs.url }}"
          
          # 3000ms ç­‰å¾…å³å¯
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=3000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          git push
