(function () {
    console.log("ðŸ”’ V12 å…¨åŸŸéŽ–å®šï¼šYouTube Fake Player å•Ÿå‹•");

    // å…¨åŸŸéŽ–ï¼ˆè¨˜éŒ„å·²è™•ç†éŽçš„å½±ç‰‡ IDï¼‰
    if (!window.__PROCESSED_VIDEOS) {
        window.__PROCESSED_VIDEOS = new Set();
    }

    /***
     * åŠŸèƒ½ï¼šæŽƒæé é¢ã€ç§»é™¤å¤šé¤˜ iframeã€ç”Ÿæˆå”¯ä¸€ fake å½±ç‰‡æŒ‰éˆ•
     */
    function scanYoutube() {
        cleanupFakePlayers();
        processIframes();
    }

    /***
     * æ¸…ç† DOM ä¸Šçš„ fake playerï¼š
     * - ç§»é™¤ç©ºæ®¼ï¼ˆæ²’æœ‰ç´…è‰²æŒ‰éˆ•ï¼‰
     * - ç§»é™¤é‡è¤‡åŒ ID çš„ player
     */
    function cleanupFakePlayers() {
        const players = document.querySelectorAll('.my-fake-player');
        const seen = new Set();

        players.forEach(player => {
            const id = player.dataset.videoid;

            // 1. ç„¡æœ‰æ•ˆå…§å®¹ â†’ åˆªé™¤ï¼ˆæ¨™æº–å¤–è§€å…§å«ç´…è‰²æŒ‰éˆ•ï¼‰
            if (!player.innerHTML.includes('background:red')) {
                console.log("ðŸ—‘ï¸ åˆªé™¤ç©ºæ®¼ fake player:", id);
                player.remove();
                return;
            }

            // 2. é‡è¤‡ fake player â†’ åˆªé™¤
            if (seen.has(id)) {
                console.log("âœ‚ï¸ åˆªé™¤é‡è¤‡ fake player:", id);
                player.remove();
                return;
            }

            seen.add(id);
        });
    }

    /***
     * è™•ç† YouTube iframe
     */
    function processIframes() {
        const iframes = document.querySelectorAll('iframe');

        iframes.forEach((iframe) => {
            const src = iframe.src || iframe.dataset.src || "";
            if (!src.includes("youtube") && !src.includes("youtu.be")) return;

            // æŠ½å‡ºå½±ç‰‡ ID
            const match = src.match(/([a-zA-Z0-9_-]{11})/);
            const videoId = match ? match[1] : null;
            if (!videoId) return;

            // å¦‚æžœé€™å€‹å½±ç‰‡å·²ç¶“å»ºç«‹éŽ fake player â†’ åˆªé™¤æ‰€æœ‰å¤šé¤˜ iframe
            if (window.__PROCESSED_VIDEOS.has(videoId)) {
                console.log("âœ‚ï¸ åˆªé™¤å¤šé¤˜ iframe:", videoId);

                const exists = document.querySelector(`.my-fake-player[data-videoid="${videoId}"]`);
                if (exists) {
                    iframe.remove();
                    return;
                }
            }

            // è™•ç†ç¬¬ä¸€å€‹ï¼ˆå°šæœªå»ºç«‹ fake playerï¼‰
            createFakePlayer(iframe, videoId);

            // åŠ å…¥å…¨åŸŸéŽ–ï¼ˆä¿è­‰åŒå½±ç‰‡ä¸æœƒå†ç”Ÿæˆç¬¬äºŒæ¬¡ï¼‰
            window.__PROCESSED_VIDEOS.add(videoId);
        });
    }

    /***
     * å»ºç«‹ Fake Playerï¼ˆæŒ‰éˆ• + èƒŒæ™¯åœ–ï¼‰
     */
    function createFakePlayer(iframe, videoId) {
        console.log("âœ¨ å»ºç«‹ fake player:", videoId);

        const bg = `url(https://img.youtube.com/vi/${videoId}/hqdefault.jpg)`;

        let w = iframe.offsetWidth > 10 ? iframe.offsetWidth + "px" : "100%";
        let h = iframe.offsetHeight > 10 ? iframe.offsetHeight + "px" : "315px";
        if (parseInt(h) < 100) h = "315px";

        const url = "https://www.youtube.com/watch?v=" + videoId;

        const a = document.createElement("a");
        a.className = "my-fake-player";
        a.dataset.videoid = videoId;
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";

        a.style.cssText = `
            width: ${w};
            height: ${h};
            min-height: 315px;
            background:#000 ${bg} center/cover no-repeat;
            display:flex;
            align-items:center;
            justify-content:center;
            border-radius:8px;
            text-decoration:none;
            position:relative;
            margin:20px auto;
            z-index:9999;
            box-shadow:0 4px 10px rgba(0,0,0,0.3);
        `;

        // ç´…è‰²æ’­æ”¾æŒ‰éˆ•
        a.innerHTML = `
            <div style="background:rgba(0,0,0,0.6);width:100%;height:100%;display:flex;
                align-items:center;justify-content:center;border-radius:8px;">
                <div style="background:red;width:60px;height:40px;border-radius:10px;
                    display:flex;align-items:center;justify-content:center;
                    box-shadow:0 2px 5px rgba(0,0,0,0.3);">
                    <div style="width:0;height:0;border-top:8px solid transparent;
                        border-bottom:8px solid transparent;border-left:12px solid white;
                        margin-left:4px;"></div>
                </div>

                <div style="position:absolute;bottom:10px;color:white;font-size:12px;
                    background:rgba(0,0,0,0.5);padding:2px 6px;border-radius:4px;
                    font-family:sans-serif;">
                    é»žæ“Šé–‹å•Ÿå½±ç‰‡
                </div>
            </div>
        `;

        iframe.replaceWith(a);
    }

    /***
     * ä¸»è¿´åœˆï¼šæš´åŠ›æŽƒ 20 ç§’ï¼Œæ¯ 100ms åŸ·è¡Œä¸€æ¬¡
     */
    let count = 0;
    const interval = setInterval(() => {
        scanYoutube();
        count++;
        if (count > 200) clearInterval(interval); // 200 æ¬¡ = 20 ç§’
    }, 100);

    scanYoutube();
})();
