name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'è«‹è¼¸å…¥è¦æŠ“å–çš„ç¶²å€ (URL)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v13
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- æ­¥é©Ÿ 1: å»ºç«‹ã€ŒV13 å–®æ¬¡ç‹™æ“Šç‰ˆã€YouTube å½è£è…³æœ¬ ---
      - name: Create One-Shot Faker Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("ğŸ›‘ V13 å–®æ¬¡ç‹™æ“Šç‰ˆï¼šæº–å‚™ä¸­...");

            // å®šç¾©æ ¸å¿ƒé‚è¼¯ (ä¸åŸ·è¡Œï¼Œç­‰æ™‚é–“åˆ°æ‰è·‘)
            function executeSniper() {
                console.log("ğŸ’¥ V13 ç‹™æ“Šé–‹å§‹ï¼");
                
                const iframes = document.querySelectorAll('iframe');
                const processedIds = new Set(); // é€™æ¬¡åŸ·è¡Œä¸­è™•ç†éçš„ ID

                iframes.forEach(iframe => {
                    const src = iframe.src || iframe.dataset.src || "";
                    if (!src.includes('youtube') && !src.includes('youtu.be')) return;

                    // æŠ“å– ID
                    const match = src.match(/([a-zA-Z0-9_-]{11})/);
                    const videoId = match ? match[1] : null;

                    if (!videoId) return;

                    // --- é—œéµé‚è¼¯ï¼šåŒä¸€æ¬¡åŸ·è¡Œä¸­ï¼Œé‡åˆ°é‡è¤‡çš„ ID å°±æ®ºæ‰ ---
                    if (processedIds.has(videoId)) {
                        console.log("ğŸ—‘ï¸ ç™¼ç¾é‡è¤‡ iframe (" + videoId + ")ï¼Œç§»é™¤ï¼");
                        iframe.remove();
                        return;
                    }

                    // è¨˜éŒ„é€™å€‹ ID
                    processedIds.add(videoId);

                    // è£½ä½œæ’­æ”¾å™¨
                    createPlayer(iframe, videoId);
                });
                
                console.log("âœ… V13 ä»»å‹™å®Œæˆï¼Œæ”¶å·¥ã€‚");
            }

            function createPlayer(iframe, videoId) {
                const bgImage = 'url(https://img.youtube.com/vi/' + videoId + '/hqdefault.jpg)';
                
                // å¯¬é«˜è™•ç†
                let width = iframe.offsetWidth > 10 ? iframe.offsetWidth + "px" : "100%";
                let height = iframe.offsetHeight > 10 ? iframe.offsetHeight + "px" : "315px";
                if (parseInt(height) < 100) height = "315px";

                const targetUrl = 'https://www.youtube.com/watch?v=' + videoId;

                const fakePlayer = document.createElement('a');
                fakePlayer.className = 'my-fake-player';
                fakePlayer.href = targetUrl;
                fakePlayer.target = "_blank";
                fakePlayer.rel = "noopener noreferrer";
                
                fakePlayer.style.cssText = \`
                    width: \${width};
                    height: \${height};
                    min-height: 315px;
                    background: #000 \${bgImage} center/cover no-repeat;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-decoration: none;
                    border-radius: 8px;
                    position: relative;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                    margin: 20px auto;
                    z-index: 9999;
                \`;

                fakePlayer.innerHTML = \`
                    <div style="background:rgba(0,0,0,0.6);width:100%;height:100%;display:flex;align-items:center;justify-content:center;border-radius:8px;">
                        <div style="background:red;width:60px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);">
                            <div style="width:0;height:0;border-top:8px solid transparent;border-bottom:8px solid transparent;border-left:12px solid white;margin-left:4px;"></div>
                        </div>
                    </div>
                \`;
                
                // æ›¿æ›
                if(iframe.parentNode) {
                    iframe.replaceWith(fakePlayer);
                }
            }

            // --- åªæœ‰é€™è£¡ä¸åŒ ---
            // ä¸ç”¨ setIntervalï¼Œæ”¹ç”¨ setTimeout
            // å»¶é² 10 ç§’åŸ·è¡Œ (10000ms)ï¼Œçµ¦ç¶²é è¶³å¤ çš„æ™‚é–“å†·éœä¸‹ä¾†
            setTimeout(executeSniper, 10000);

          })();
          EOF

      # --- æ­¥é©Ÿ 2: åŸ·è¡ŒæŠ“å– ---
      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "æ­£åœ¨æŠ“å–: ${{ inputs.url }}"
          
          # å°‡ timeout è¨­é•·ä¸€é»ï¼Œç¢ºä¿æˆ‘å€‘çš„ 10ç§’ å»¶é²ä¸æœƒè¶…æ™‚
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=12000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          git push
