name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'è«‹è¼¸å…¥è¦æŠ“å–çš„ç¶²å€ (URL)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v29
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- æ­¥é©Ÿ 1: å»ºç«‹ã€ŒV29 Vimeo å¾©æ´»ç‰ˆã€ä¿®å¾©è…³æœ¬ ---
      - name: Create V29 Faker Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("ğŸ”¥ V29 Vimeo å¾©æ´»ç‰ˆï¼šå•Ÿå‹•");

            function fixAllIframes() {
                const iframes = document.querySelectorAll('iframe');
                
                iframes.forEach(iframe => {
                    const src = iframe.src || iframe.dataset.src || "";
                    
                    if (!src || src === "about:blank") return;
                    if (iframe.offsetWidth < 50 || iframe.offsetHeight < 50) return;
                    if (iframe.dataset.patched === "true") return;

                    const parent = iframe.parentElement;
                    if (!parent) return;

                    const parentStyle = window.getComputedStyle(parent);
                    if (parentStyle.position === 'static') {
                        parent.style.position = 'relative';
                    }

                    let bgImage = '';
                    let bgColor = '#222';
                    let btnText = "é»æ“Šé–‹å•Ÿ å¤–éƒ¨åµŒå…¥å…§å®¹";
                    let btnIcon = "ğŸ”—";
                    let btnColor = "#007bff";
                    let linkUrl = src;

                    // A. YouTube
                    if (src.includes('youtube') || src.includes('youtu.be')) {
                        const match = src.match(/([a-zA-Z0-9_-]{11})/);
                        if (match) {
                            const videoId = match[1];
                            bgImage = 'url(https://img.youtube.com/vi/' + videoId + '/hqdefault.jpg)';
                            bgColor = '#000';
                            btnText = "é»æ“Šé–‹å•Ÿ YouTube å½±ç‰‡";
                            btnIcon = "â–¶";
                            btnColor = "#cc0000";
                            linkUrl = 'https://www.youtube.com/watch?v=' + videoId;
                        }
                    }

                    // B. Vimeo (Vumbnail)
                    if (src.includes('vimeo.com')) {
                        const match = src.match(/video\/(\d+)/);
                        if (match) {
                            const vimeoId = match[1];
                            // ä½¿ç”¨ç¬¬ä¸‰æ–¹è½‰å€æœå‹™ç²å–ç¸®åœ–
                            bgImage = 'url(https://vumbnail.com/' + vimeoId + '.jpg)';
                            bgColor = '#000';
                            btnText = "é»æ“Šé–‹å•Ÿ Vimeo å½±ç‰‡";
                            btnIcon = "â–¶";
                            btnColor = "#1ab7ea";
                            linkUrl = 'https://vimeo.com/' + vimeoId;
                        }
                    }

                    const card = document.createElement('a');
                    card.href = linkUrl;
                    card.target = "_blank";
                    card.rel = "noopener noreferrer";
                    
                    card.style.cssText = \`
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background-color: \${bgColor};
                        background-image: \${bgImage};
                        background-position: center;
                        background-size: cover;
                        background-repeat: no-repeat;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        text-decoration: none;
                        z-index: 10;
                        box-sizing: border-box;
                        border: 2px solid \${btnColor};
                    \`;

                    card.innerHTML = \`
                        <div style="background: rgba(0,0,0,0.6); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div style="font-size: 40px; margin-bottom: 10px;">\${btnIcon}</div>
                            <div style="background-color: \${btnColor}; color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold; font-size: 14px; font-family: sans-serif; box-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                                \${btnText}
                            </div>
                            <div style="margin-top: 8px; color: #aaa; font-size: 10px; font-family: monospace; max-width: 80%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ä¾†æº: \${src}
                            </div>
                        </div>
                    \`;

                    parent.appendChild(card);
                    iframe.style.opacity = '0';
                    iframe.style.pointerEvents = 'none';
                    iframe.dataset.patched = "true";
                });
            }

            let attempts = 0;
            const interval = setInterval(() => {
                fixAllIframes();
                attempts++;
                if (attempts > 30) clearInterval(interval);
            }, 500);
            
            fixAllIframes();
          })();
          EOF

      # --- æ­¥é©Ÿ 2: åŸ·è¡ŒæŠ“å– ---
      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "æ­£åœ¨æŠ“å–: ${{ inputs.url }}"
          
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=3000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          git push
