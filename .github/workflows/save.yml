name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'è«‹è¼¸å…¥è¦æŠ“å–çš„ç¶²å€ (URL)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v6
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- æ­¥é©Ÿ 1: å»ºç«‹ã€ŒYouTube å½è£è¡“ã€è…³æœ¬ ---
      - name: Create YouTube Faker Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("ğŸ¨ YouTube å½è£è…³æœ¬å•Ÿå‹•...");

            function fixYoutube() {
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    // 1. æª¢æŸ¥æ˜¯å¦è™•ç†é
                    if (iframe.dataset.fixed === "true") return;

                    const src = iframe.src || iframe.dataset.src || "";
                    
                    // 2. ç²¾æº–æ­£å‰‡è¡¨é”å¼ï¼šåªæŠ“ YouTube å½±ç‰‡ ID
                    // (é€™æœƒéæ¿¾æ‰å»£å‘Šæˆ–å…¶ä»–éå½±ç‰‡çš„ iframe)
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                    const match = src.match(regExp);

                    // 3. åªæœ‰ç•¶ç¢ºèªæ˜¯ YouTube ä¸”æŠ“åˆ° ID æ™‚æ‰åŸ·è¡Œ
                    if (match && match[2].length === 11) {
                        const videoId = match[2];
                        console.log("ğŸ¯ ç™¼ç¾ YouTube å½±ç‰‡ ID: " + videoId);

                        // æŠ“å–åŸæœ¬ iframe çš„å°ºå¯¸
                        const rect = iframe.getBoundingClientRect();
                        const width = rect.width > 0 ? rect.width + "px" : "100%";
                        const height = rect.height > 0 ? rect.height + "px" : "315px";

                        // 4. å»ºç«‹å½è£çš„æ’­æ”¾å™¨ (div)
                        const fakePlayer = document.createElement('div');
                        
                        // è¨­å®šæ¨£å¼ï¼šèƒŒæ™¯åœ–ä½¿ç”¨ YouTube å®˜æ–¹é«˜ç•«è³ªç¸®åœ–
                        fakePlayer.style.cssText = \`
                            width: \${width};
                            height: \${height};
                            background-image: url('https://img.youtube.com/vi/\${videoId}/hqdefault.jpg');
                            background-size: cover;
                            background-position: center;
                            background-repeat: no-repeat;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            cursor: pointer;
                            border-radius: 8px;
                            position: relative;
                            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                        \`;

                        // 5. åŠ ä¸ŠåŠé€æ˜é»‘ç½©å’Œæ’­æ”¾æŒ‰éˆ•ï¼Œè®“å®ƒçœ‹èµ·ä¾†åƒå½±ç‰‡
                        fakePlayer.innerHTML = \`
                            <div style="
                                width: 100%; height: 100%;
                                background: rgba(0,0,0,0.4);
                                display: flex; align-items: center; justify-content: center;
                                border-radius: 8px;
                            ">
                                <div style="
                                    width: 60px; height: 40px;
                                    background: red;
                                    border-radius: 10px;
                                    display: flex; align-items: center; justify-content: center;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                ">
                                    <div style="
                                        width: 0; height: 0;
                                        border-top: 8px solid transparent;
                                        border-bottom: 8px solid transparent;
                                        border-left: 12px solid white;
                                        margin-left: 4px;
                                    "></div>
                                </div>
                            </div>
                        \`;
                        
                        // 6. é»æ“Šäº‹ä»¶ï¼šé–‹å•Ÿæ–°åˆ†é 
                        fakePlayer.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            // ç”¨ _blank å¼·åˆ¶é–‹å•Ÿæ–°è¦–çª—ï¼Œè§£æ±º Error 153
                            window.open('https://www.youtube.com/watch?v=' + videoId, '_blank');
                        };

                        // 7. æ›¿æ›æ‰åŸæœ¬çš„ iframe (æ®ºæ‰ Error 153 çš„æºé ­)
                        if(iframe.parentNode) {
                            iframe.parentNode.replaceChild(fakePlayer, iframe);
                            // æ¨™è¨˜æ–°å…ƒç´ ï¼Œé¿å…é‡è¤‡è™•ç†
                            fakePlayer.dataset.fixed = "true";
                        }
                    }
                });
            }

            // æŒçºŒæƒæ 30 ç§’ (æ‡‰ä»˜ Lazy Loading)
            let attempts = 0;
            const interval = setInterval(() => {
                fixYoutube();
                attempts++;
                if (attempts > 60) clearInterval(interval);
            }, 500);
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            fixYoutube();
          })();
          EOF

      # --- æ­¥é©Ÿ 2: åŸ·è¡ŒæŠ“å– ---
      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "æ­£åœ¨æŠ“å–: ${{ inputs.url }}"
          
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=2000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          git push
