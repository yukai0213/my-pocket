name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'è«‹è¼¸å…¥è¦æŠ“å–çš„ç¶²å€ (URL)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

# ç§»é™¤ concurrencyï¼Œå…è¨±ä»»å‹™æ’éšŠåŸ·è¡Œï¼Œä¸å–æ¶ˆèˆŠä»»å‹™
# é€™æ¨£ä½ å¯ä»¥é€£çºŒæŒ‰å¥½å¹¾æ¬¡ Save

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v44
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- æ­¥é©Ÿ 1: å»ºç«‹ã€ŒV44 çµ‚æ¥µè·³è½‰ç‰ˆã€è…³æœ¬ ---
      - name: Create V44 Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("ğŸš€ V44 çµ‚æ¥µè·³è½‰ç‰ˆï¼šå•Ÿå‹• (Absolute Div + Click Handler)");

            // 1. è§¸ç™¼æ‡¶åŠ è¼‰
            window.scrollBy(0, 100);
            setTimeout(() => window.scrollBy(0, -100), 500);

            // è¼”åŠ©ï¼šç©¿é€ Shadow DOM æœå°‹å…ƒç´ 
            function queryAllDeep(selector, root = document) {
                let elements = Array.from(root.querySelectorAll(selector));
                const hosts = Array.from(root.querySelectorAll('*')).filter(e => e.shadowRoot);
                for (const host of hosts) {
                    elements = elements.concat(queryAllDeep(selector, host.shadowRoot));
                }
                return elements;
            }

            function fixAll() {
                // æœå°‹æ‰€æœ‰ iframe å’Œ video
                const targets = [...queryAllDeep('iframe'), ...queryAllDeep('video')];
                
                targets.forEach(el => {
                    const tagName = el.tagName.toLowerCase();
                    let src = "";
                    
                    // æŠ“å–ç¶²å€
                    if (tagName === 'iframe') {
                        src = el.src || el.dataset.src || el.dataset.original || "";
                    } else if (tagName === 'video') {
                        src = el.currentSrc || el.src || (el.querySelector('source') ? el.querySelector('source').src : "");
                    }

                    // éæ¿¾ç„¡æ•ˆå…ƒç´ 
                    if (!src || src === "about:blank") return;
                    if (el.offsetWidth < 30 || el.offsetHeight < 30) return; // å¤ªå°çš„å¿½ç•¥
                    
                    // é˜²é‡æ©Ÿåˆ¶ï¼šæª¢æŸ¥æ˜¯å¦å·²ç¶“è™•ç†é
                    // æˆ‘å€‘æª¢æŸ¥çˆ¶å®¹å™¨è£¡é¢æ˜¯å¦å·²ç¶“æœ‰æˆ‘å€‘çš„ card äº†
                    if (el.parentNode.querySelector('.my-fix-card')) return;

                    // æº–å‚™æŒ‰éˆ•æ¨£å¼è³‡æ–™
                    let type = "other";
                    let videoId = null;
                    let bgImage = '';
                    let bgColor = '#222';
                    let btnText = "é»æ“Šé–‹å•Ÿ å¤–éƒ¨å…§å®¹";
                    let btnIcon = "ğŸ”—";
                    let btnColor = "#007bff"; // è—è‰²
                    let linkUrl = src;

                    // åˆ¤æ–·é¡å‹
                    if (src.includes('youtube') || src.includes('youtu.be')) {
                        type = "youtube";
                        const match = src.match(/([a-zA-Z0-9_-]{11})/);
                        if (match) videoId = match[1];
                    } else if (src.includes('vimeo.com')) {
                        type = "vimeo";
                        const match = src.match(/video\/(\d+)/);
                        if (match) videoId = match[1];
                    }

                    // è¨­å®šå°æ‡‰æ¨£å¼
                    if (type === "youtube" && videoId) {
                        bgImage = 'url(https://img.youtube.com/vi/' + videoId + '/hqdefault.jpg)';
                        bgColor = '#000';
                        btnText = "é»æ“Šé–‹å•Ÿ YouTube";
                        btnIcon = "â–¶";
                        btnColor = "#cc0000"; // ç´…è‰²
                        linkUrl = 'https://www.youtube.com/watch?v=' + videoId;
                    } else if (type === "vimeo" && videoId) {
                        bgImage = 'url(https://vumbnail.com/' + videoId + '.jpg)';
                        bgColor = '#000';
                        btnText = "é»æ“Šé–‹å•Ÿ Vimeo";
                        btnIcon = "â–¶";
                        btnColor = "#1ab7ea"; // è—è‰²
                        linkUrl = 'https://vimeo.com/' + videoId;
                    } else if (tagName === 'video') {
                        // ä¿®æ­£ç›¸å°è·¯å¾‘ç‚ºçµ•å°è·¯å¾‘
                        try { linkUrl = new URL(src, document.baseURI).href; } catch(e) {}
                        
                        btnText = "ä¸‹è¼‰/æ’­æ”¾ åŸå§‹æª”";
                        btnIcon = "ğŸ¬";
                        btnColor = "#28a745"; // ç¶ è‰²
                    }

                    // è£½ä½œå¡ç‰‡ (ä½¿ç”¨ DIV é¿å…å·¢ç‹€é€£çµéŒ¯èª¤)
                    const card = document.createElement('div');
                    card.className = 'my-fix-card';
                    
                    // é»æ“Šäº‹ä»¶ (å¼·åˆ¶é–‹æ–°è¦–çª—)
                    card.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¸ç™¼å¤–å±¤é€£çµ
                        window.open(linkUrl, '_blank');
                    };
                    
                    card.style.cursor = 'pointer';

                    // æ¨£å¼ï¼šçµ•å°å®šä½è¦†è“‹ (æœ€ç©©å®šçš„æ’ç‰ˆæ–¹å¼)
                    card.style.cssText = \`
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background-color: \${bgColor};
                        background-image: \${bgImage};
                        background-position: center;
                        background-size: cover;
                        background-repeat: no-repeat;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        z-index: 10; /* ç¢ºä¿æµ®åœ¨æœ€ä¸Šå±¤ï¼Œä¿è­‰å¯é» */
                        border-radius: inherit; /* è·Ÿéš¨çˆ¶å®¹å™¨åœ“è§’ */
                        box-sizing: border-box;
                        border: 2px solid \${btnColor};
                    \`;

                    card.innerHTML = \`
                        <div style="background: rgba(0,0,0,0.7); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: inherit;">
                            <div style="font-size: 32px; margin-bottom: 5px;">\${btnIcon}</div>
                            <div style="background-color: \${btnColor}; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); text-align: center;">
                                \${btnText}
                            </div>
                        </div>
                    \`;

                    // åŸ·è¡Œæ›¿æ›
                    if(el.parentNode) {
                        // ç¢ºä¿çˆ¶å®¹å™¨æœ‰å®šä½å±¬æ€§
                        const parentStyle = window.getComputedStyle(el.parentNode);
                        if (parentStyle.position === 'static') {
                            el.parentNode.style.position = 'relative';
                        }

                        // æ’å…¥å¡ç‰‡
                        el.parentNode.insertBefore(card, el);
                        
                        // ç§»é™¤åŸæœ¬çš„å½±ç‰‡ (é¿å…å®ƒåœ¨èƒŒæ™¯å·å·æ’­æ”¾æˆ–ä½”è³‡æº)
                        el.remove();
                    }
                });
            }

            // æŒçºŒæƒæ 10 ç§’
            let attempts = 0;
            const interval = setInterval(() => {
                fixAll();
                attempts++;
                if (attempts > 20) clearInterval(interval);
            }, 500);
            
            fixAll();
          })();
          EOF

      # --- æ­¥é©Ÿ 2: åŸ·è¡ŒæŠ“å– ---
      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "æ­£åœ¨æŠ“å–: ${{ inputs.url }}"
          
          # åŸ·è¡Œ SingleFile
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=3000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          
          # è‡ªå‹•åŒæ­¥é‡è©¦è¿´åœˆ (è§£æ±ºé€£çºŒæŒ‰ Save å°è‡´çš„è¡çª)
          n=0
          until [ "$n" -ge 10 ]
          do
             git pull --rebase && git push && break
             n=$((n+1))
             echo "ä¸Šå‚³è¡çªï¼Œæ­£åœ¨é‡è©¦ ($n/10)..."
             sleep 5
          done
