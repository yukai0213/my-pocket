name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'è«‹è¼¸å…¥è¦æŠ“å–çš„ç¶²å€ (URL)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v16
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- æ­¥é©Ÿ 1: å»ºç«‹ã€ŒV16 è¬ç”¨ç‰ˆã€ä¿®å¾©è…³æœ¬ ---
      - name: Create Universal Faker Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("ğŸŒ V16 è¬ç”¨ä¿®å¾©ç‰ˆï¼šå•Ÿå‹•");

            function fixIframes() {
                const iframes = document.querySelectorAll('iframe');
                
                iframes.forEach(iframe => {
                    const src = iframe.src || iframe.dataset.src || "";
                    if (!src) return; // æ²’ç¶²å€çš„ä¸ç®¡

                    // --- åˆ¤æ–· 1: æ˜¯ä¸æ˜¯ YouTube? (VIP å¾…é‡) ---
                    if (src.includes('youtube') || src.includes('youtu.be')) {
                        handleYoutube(iframe, src);
                    } 
                    // --- åˆ¤æ–· 2: å…¶ä»–æ‰€æœ‰ iframe (é€šç”¨å¾…é‡) ---
                    else {
                        handleGeneric(iframe, src);
                    }
                });
            }

            // --- è™•ç† YouTube (åœ–æ–‡åˆ†é›¢æ¨¡å¼) ---
            function handleYoutube(iframe, src) {
                const match = src.match(/([a-zA-Z0-9_-]{11})/);
                const videoId = match ? match[1] : null;
                if (!videoId) return handleGeneric(iframe, src); // æŠ“ä¸åˆ° ID å°±é™ç´šè™•ç†

                // é˜²é‡æª¢æŸ¥
                const prev = iframe.previousElementSibling;
                if (prev && prev.classList.contains('my-yt-container')) {
                    iframe.style.display = 'none';
                    return;
                }

                console.log("âœ¨ YouTube å„ªåŒ–: " + videoId);

                const bgImage = 'url(https://img.youtube.com/vi/' + videoId + '/hqdefault.jpg)';
                const targetUrl = 'https://www.youtube.com/watch?v=' + videoId;
                let width = iframe.offsetWidth > 10 ? iframe.offsetWidth + "px" : "100%";

                // å»ºç«‹å®¹å™¨
                const container = document.createElement('div');
                container.className = 'my-yt-container';
                container.style.cssText = \`
                    width: \${width};
                    margin: 20px auto;
                    font-family: sans-serif;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                    border-radius: 8px;
                    overflow: hidden;
                    background: #f0f0f0;
                \`;

                // åœ–ç‰‡å€
                const imgDiv = document.createElement('div');
                imgDiv.style.cssText = \`
                    width: 100%;
                    height: 315px;
                    background: #000 \${bgImage} center/cover no-repeat;
                    border-bottom: 1px solid #ddd;
                \`;

                // æŒ‰éˆ•å€
                const btnArea = document.createElement('div');
                btnArea.style.cssText = 'padding:15px;text-align:center;background:#fff;';
                
                const linkBtn = document.createElement('a');
                linkBtn.href = targetUrl;
                linkBtn.target = "_blank";
                linkBtn.innerText = "ğŸ“º é»æ“Šå‰å¾€ YouTube è§€çœ‹å½±ç‰‡";
                linkBtn.style.cssText = 'display:inline-block;background-color:#cc0000;color:white;padding:10px 20px;border-radius:5px;text-decoration:none;font-weight:bold;';

                btnArea.appendChild(linkBtn);
                container.appendChild(imgDiv);
                container.appendChild(btnArea);

                if(iframe.parentNode) {
                    iframe.parentNode.insertBefore(container, iframe);
                    iframe.style.display = 'none';
                }
            }

            // --- è™•ç† é€šç”¨ iframe (ä¿ç•™åŸæ¨£ + é ‚éƒ¨æŒ‰éˆ•) ---
            function handleGeneric(iframe, src) {
                // é˜²é‡æª¢æŸ¥ï¼šçœ‹é ­é ‚ä¸Šæœ‰æ²’æœ‰æŒ‰éˆ•
                const prev = iframe.previousElementSibling;
                if (prev && prev.classList.contains('my-generic-link')) {
                    return; // å·²ç¶“åŠ éæŒ‰éˆ•äº†ï¼Œè·³é
                }

                console.log("ğŸ”— é€šç”¨ iframe è£œå¼·: " + src);

                // å»ºç«‹ä¸€å€‹ç°¡å–®çš„é€£çµæ¢
                const linkBar = document.createElement('a');
                linkBar.className = 'my-generic-link'; // æ¨™è¨˜
                linkBar.href = src;
                linkBar.target = "_blank";
                linkBar.innerText = "ğŸ”— ç„¡æ³•é è¦½å…§å®¹ï¼Ÿé»æ­¤é–‹å•ŸåŸå§‹é€£çµ";
                
                // æ¨£å¼ï¼šåƒæ˜¯ä¸€å€‹å°æ¨™ç±¤è²¼åœ¨ iframe é ­é ‚
                linkBar.style.cssText = \`
                    display: block;
                    background-color: #444;
                    color: #fff;
                    padding: 8px 15px;
                    font-size: 14px;
                    text-decoration: none;
                    text-align: center;
                    border-radius: 4px;
                    margin-bottom: 5px;
                    font-family: sans-serif;
                    opacity: 0.9;
                \`;

                // æ’å…¥åœ¨ iframe å‰é¢ (ä¸åˆªé™¤ iframeï¼)
                if(iframe.parentNode) {
                    iframe.parentNode.insertBefore(linkBar, iframe);
                }
            }

            // æƒææ©Ÿåˆ¶
            let attempts = 0;
            const interval = setInterval(() => {
                fixIframes();
                attempts++;
                if (attempts > 40) clearInterval(interval);
            }, 500);
            
            fixIframes();
          })();
          EOF

      # --- æ­¥é©Ÿ 2: åŸ·è¡ŒæŠ“å– ---
      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "æ­£åœ¨æŠ“å–: ${{ inputs.url }}"
          
          # 3000ms ç­‰å¾…
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=3000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          git push
