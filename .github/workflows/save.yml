name: Save Webpage
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'è«‹è¼¸å…¥è¦æŠ“å–çš„ç¶²å€ (URL)'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-singlefile-v12
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install SingleFile
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm install -g single-file-cli

      - name: Link SingleFile
        run: npm link single-file-cli

      # --- æ­¥é©Ÿ 1: å»ºç«‹ã€ŒV10 æ™‚ç©ºè­¦å¯Ÿç‰ˆã€YouTube å½è£è…³æœ¬ ---
      - name: Create Highlander Faker Script
        run: |
          cat <<EOF > fix-youtube.js
          (function() {
            console.log("âš”ï¸ V10 æ™‚ç©ºè­¦å¯Ÿè…³æœ¬å•Ÿå‹•ï¼šåªèƒ½ç•™ä¸€å€‹ï¼");

            function enforceSingleton() {
                // --- ç¬¬ä¸€éšæ®µï¼šæ¸…ç†é–€æˆ¶ (æ¸…é™¤å¤šé¤˜çš„å½è£å™¨) ---
                // 1. æŠ“å‡ºæ‰€æœ‰æˆ‘å€‘åšå¥½çš„æ’­æ”¾å™¨
                const players = Array.from(document.querySelectorAll('.my-fake-player'));
                const playerMap = new Map(); // ç”¨ä¾†åˆ†çµ„: ID -> [å…ƒç´ 1, å…ƒç´ 2...]

                players.forEach(p => {
                    const id = p.dataset.videoid;
                    if (id) {
                        if (!playerMap.has(id)) playerMap.set(id, []);
                        playerMap.get(id).push(p);
                    }
                });

                // 2. æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡
                playerMap.forEach((list, id) => {
                    if (list.length > 1) {
                        console.log("ğŸ”ª ç™¼ç¾ " + list.length + " å€‹é‡è¤‡æ’­æ”¾å™¨ (ID: " + id + ")ï¼Œé–‹å§‹æ¸…ç†...");
                        
                        // ç­–ç•¥ï¼šä¿ç•™å…§å®¹æœ€å®Œæ•´çš„é‚£ä¸€å€‹ (innerHTML æœ€é•·çš„)
                        // å¦‚æœéƒ½å¾ˆçŸ­ï¼Œå°±ä¿ç•™ç¬¬ä¸€å€‹
                        list.sort((a, b) => b.innerHTML.length - a.innerHTML.length);
                        
                        // ä¿ç•™ list[0]ï¼Œåˆªé™¤å…¶ä»–çš„
                        for (let i = 1; i < list.length; i++) {
                            list[i].remove();
                            console.log("ğŸ—‘ï¸ å·²åˆªé™¤å¤šé¤˜æ’­æ”¾å™¨");
                        }
                    }
                });

                // --- ç¬¬äºŒéšæ®µï¼šè™•ç† iframe ---
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    const src = iframe.src || iframe.dataset.src || "";
                    // å¯¬é¬†åŒ¹é… YouTube
                    if (src.includes('youtube') || src.includes('youtu.be')) {
                        
                        // æå– ID
                        let videoId = null;
                        const match = src.match(/([a-zA-Z0-9_-]{11})/);
                        if (match) videoId = match[1];

                        if (videoId) {
                            // æª¢æŸ¥ï¼šç¾åœ¨æ˜¯å¦å·²ç¶“æœ‰ã€Œæ´»è‘—çš„ã€æ’­æ”¾å™¨äº†ï¼Ÿ
                            // é€™è£¡æˆ‘å€‘é‡æ–°æŸ¥è©¢ DOMï¼Œç¢ºä¿æ‹¿åˆ°æœ€æ–°ç‹€æ…‹
                            const existingPlayer = document.querySelector('.my-fake-player[data-videoid="' + videoId + '"]');

                            if (existingPlayer) {
                                // å¦‚æœæ’­æ”¾å™¨å·²ç¶“å­˜åœ¨ï¼Œé€™å€‹ iframe å°±æ˜¯å¤šé¤˜çš„åƒåœ¾ -> åˆªé™¤
                                iframe.remove();
                            } else {
                                // å¦‚æœä¸å­˜åœ¨ï¼Œæ‰å‡†å»ºç«‹æ–°çš„
                                createPlayer(iframe, videoId);
                            }
                        }
                    }
                });
            }

            // å»ºç«‹æ’­æ”¾å™¨çš„å‡½æ•¸ (å°è£èµ·ä¾†)
            function createPlayer(iframe, videoId) {
                console.log("âœ¨ å»ºç«‹å”¯ä¸€æ’­æ”¾å™¨: " + videoId);
                
                const bgImage = 'url(https://img.youtube.com/vi/' + videoId + '/hqdefault.jpg)';
                
                // æŠ“å–å°ºå¯¸
                let width = iframe.offsetWidth > 10 ? iframe.offsetWidth + "px" : "100%";
                let height = iframe.offsetHeight > 10 ? iframe.offsetHeight + "px" : "315px";
                if (parseInt(height) < 100) height = "315px";

                const targetUrl = 'https://www.youtube.com/watch?v=' + videoId;

                const fakePlayer = document.createElement('a');
                fakePlayer.className = 'my-fake-player'; // æ¨™è¨˜èº«åˆ†
                fakePlayer.dataset.videoid = videoId;    // æ¨™è¨˜ ID
                fakePlayer.href = targetUrl;
                fakePlayer.target = "_blank";
                fakePlayer.rel = "noopener noreferrer";
                
                fakePlayer.style.cssText = \`
                    width: \${width};
                    height: \${height};
                    min-height: 315px;
                    background: #000 \${bgImage} center/cover no-repeat;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-decoration: none;
                    border-radius: 8px;
                    position: relative;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                    margin: 20px auto;
                    z-index: 9999;
                \`;

                fakePlayer.innerHTML = \`
                    <div style="background:rgba(0,0,0,0.6);width:100%;height:100%;display:flex;align-items:center;justify-content:center;border-radius:8px;">
                        <div style="background:red;width:60px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);">
                            <div style="width:0;height:0;border-top:8px solid transparent;border-bottom:8px solid transparent;border-left:12px solid white;margin-left:4px;"></div>
                        </div>
                        <div style="position:absolute;bottom:10px;color:white;font-size:12px;background:rgba(0,0,0,0.5);padding:2px 6px;border-radius:4px;font-family:sans-serif;">
                            é»æ“Šé–‹å•Ÿå½±ç‰‡
                        </div>
                    </div>
                \`;
                
                if(iframe.parentNode) {
                    iframe.parentNode.insertBefore(fakePlayer, iframe);
                    iframe.remove();
                }
            }

            // åŸ·è¡Œé »ç‡ï¼šæ¯ 200ms æª¢æŸ¥ä¸€æ¬¡ï¼Œç¢ºä¿é‡è¤‡çš„ç¬é–“è¢«åˆªé™¤
            let attempts = 0;
            const interval = setInterval(() => {
                enforceSingleton();
                attempts++;
                if (attempts > 150) clearInterval(interval);
            }, 200);
            
            enforceSingleton();
          })();
          EOF

      # --- æ­¥é©Ÿ 2: åŸ·è¡ŒæŠ“å– ---
      - name: Save Page
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          FILENAME="saved-${TIMESTAMP}.html"
          
          echo "æ­£åœ¨æŠ“å–: ${{ inputs.url }}"
          
          # ç­‰å¾…æ™‚é–“è¨­å®š 5000msï¼Œè®“æ¸…ç†è…³æœ¬æœ‰æ™‚é–“è·‘å®Œ
          timeout 5m single-file "${{ inputs.url }}" "$FILENAME" \
            --browser-executable-path=/usr/bin/google-chrome-stable \
            --browser-script=fix-youtube.js \
            --block-scripts=false \
            --load-deferred-images-max-idle-time=5000 \
            --browser-width=1920 \
            --browser-height=1080 \
            --browser-args='["--no-sandbox", "--disable-setuid-sandbox"]'
          
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add "$FILENAME"
          git commit -m "Saved: ${{ inputs.url }}"
          git push
